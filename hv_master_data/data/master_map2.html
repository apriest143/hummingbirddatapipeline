<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Hummingbird ‚Äî Institution Risk Intelligence</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,500;0,9..40,700;1,9..40,400&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f1117; --surface: #181a20; --surface2: #1e2028; --border: #2a2d37;
            --text: #e2e4e9; --text2: #8b8fa3; --accent: #6c5ce7; --accent2: #a29bfe;
            --critical: #ff4757; --high: #ff6b35; --elevated: #ffa502; --moderate: #3b82f6;
            --low: #10b981; --healthy: #10b981; --dual: #ff4757;
            --ipeds: #6c5ce7; --hb990: #00b894; --research: #e056fd;
            --closed-fill: #3a3a4a; --closed-border: #5a5a72;
            --font: 'DM Sans', -apple-system, sans-serif; --mono: 'JetBrains Mono', monospace;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font); background: var(--bg); color: var(--text); }
        #map { width: 100%; height: 100vh; }
        .leaflet-tile-pane { filter: saturate(0.3) brightness(0.65); }
        .leaflet-marker-pane, .leaflet-popup-pane, .leaflet-overlay-pane { filter: none; }
        .marker-cluster-small, .marker-cluster-medium, .marker-cluster-large { background: rgba(108,92,231,0.25) !important; }
        .marker-cluster-small div, .marker-cluster-medium div, .marker-cluster-large div { background: rgba(108,92,231,0.7) !important; color: white !important; font-family: var(--mono) !important; font-size: 12px !important; }

        #sidebar { position: absolute; top: 0; left: 0; z-index: 1000; width: 370px; height: 100vh; background: var(--surface); border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; transition: transform 0.3s ease; }
        #sidebar.collapsed { transform: translateX(-370px); }
        #sidebar-toggle { position: absolute; top: 12px; z-index: 1001; left: 370px; width: 32px; height: 32px; background: var(--surface); border: 1px solid var(--border); border-left: none; border-radius: 0 6px 6px 0; color: var(--text2); cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; transition: left 0.3s ease; }
        #sidebar.collapsed + #sidebar-toggle { left: 0; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); background: linear-gradient(135deg, var(--surface) 0%, var(--surface2) 100%); }
        .sidebar-header h1 { font-size: 18px; font-weight: 700; letter-spacing: -0.5px; background: linear-gradient(135deg, var(--accent2), #74b9ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .sidebar-header p { font-size: 11px; color: var(--text2); margin-top: 4px; }
        .sidebar-body { flex: 1; overflow-y: auto; padding: 16px; }
        .sidebar-body::-webkit-scrollbar { width: 4px; }
        .sidebar-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
        .section { margin-bottom: 16px; }
        .section-label { font-size: 10px; font-weight: 700; color: var(--text2); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
        .search-box { position: relative; }
        .search-box input { width: 100%; padding: 10px 12px 10px 34px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-family: var(--font); font-size: 13px; outline: none; transition: border-color 0.2s; }
        .search-box input:focus { border-color: var(--accent); }
        .search-box input::placeholder { color: var(--text2); }
        .search-box .icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--text2); font-size: 14px; pointer-events: none; }
        #searchResults { position: absolute; top: calc(100% + 4px); left: 0; right: 0; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; max-height: 240px; overflow-y: auto; display: none; z-index: 10; }
        .sr-item { padding: 10px 12px; cursor: pointer; border-bottom: 1px solid var(--border); transition: background 0.15s; }
        .sr-item:hover { background: var(--bg); }
        .sr-item:last-child { border-bottom: none; }
        .sr-name { font-size: 12px; font-weight: 600; }
        .sr-meta { font-size: 10px; color: var(--text2); margin-top: 2px; }
        .tabs { display: flex; gap: 4px; }
        .tab { flex: 1; padding: 8px 4px; text-align: center; cursor: pointer; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; font-size: 11px; font-weight: 500; color: var(--text2); transition: all 0.2s; }
        .tab.active { background: var(--accent); color: white; border-color: var(--accent); }
        .tab:hover:not(.active) { background: var(--surface2); color: var(--text); }
        .color-tabs { display: flex; gap: 4px; margin-top: 8px; }
        .color-tab { flex: 1; padding: 6px 4px; text-align: center; cursor: pointer; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; font-size: 10px; font-weight: 600; color: var(--text2); transition: all 0.2s; }
        .color-tab.active { border-color: var(--accent2); color: var(--accent2); background: rgba(108,92,231,0.1); }
        .color-tab:hover:not(.active) { border-color: var(--text2); }
        select { width: 100%; padding: 8px 10px; margin-top: 6px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-family: var(--font); font-size: 12px; outline: none; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%238b8fa3'%3E%3Cpath d='M6 8L1 3h10z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 10px center; }
        select:focus { border-color: var(--accent); }
        .btn-row { display: flex; gap: 8px; margin-top: 12px; }
        .btn { flex: 1; padding: 10px; border: none; border-radius: 6px; font-family: var(--font); font-size: 12px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; }
        .btn:hover { opacity: 0.85; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-ghost { background: var(--bg); color: var(--text2); border: 1px solid var(--border); }

        /* ‚îÄ‚îÄ Closed toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .toggle-row { display: flex; align-items: center; justify-content: space-between; padding: 8px 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; margin-top: 6px; }
        .toggle-row .toggle-label { font-size: 11px; color: var(--text2); }
        .toggle-row .toggle-label span { color: var(--closed-border); font-size: 10px; display: block; margin-top: 1px; }
        .toggle-switch { position: relative; width: 32px; height: 18px; flex-shrink: 0; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; position: absolute; }
        .toggle-switch .slider { position: absolute; inset: 0; background: var(--border); border-radius: 18px; cursor: pointer; transition: background 0.2s; }
        .toggle-switch .slider:before { content: ''; position: absolute; width: 12px; height: 12px; left: 3px; top: 3px; background: white; border-radius: 50%; transition: transform 0.2s; }
        .toggle-switch input:checked + .slider { background: var(--accent); }
        .toggle-switch input:checked + .slider:before { transform: translateX(14px); }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; padding: 12px; background: var(--bg); border-radius: 8px; margin-top: 12px; }
        .stat-card { padding: 10px; background: var(--surface2); border-radius: 6px; border-left: 3px solid var(--border); }
        .stat-card.critical { border-left-color: var(--critical); }
        .stat-card.high { border-left-color: var(--high); }
        .stat-card.total { border-left-color: var(--accent); }
        .stat-card.ipeds-card { border-left-color: var(--ipeds); }
        .stat-card.hb990-card { border-left-color: var(--hb990); }
        .stat-card.closed-card { border-left-color: var(--closed-border); }
        .stat-val { font-family: var(--mono); font-size: 18px; font-weight: 700; }
        .stat-label { font-size: 9px; color: var(--text2); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px; }
        .map-legend { background: var(--surface) !important; border: 1px solid var(--border); padding: 12px; border-radius: 8px; color: var(--text); box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .map-legend h4 { font-size: 10px; color: var(--text2); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
        .map-legend .row { display: flex; align-items: center; gap: 8px; margin: 4px 0; font-size: 11px; }
        .map-legend .dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
        .map-legend .ring { width: 10px; height: 10px; border-radius: 50%; border: 2px dashed; flex-shrink: 0; }
        .leaflet-popup-content-wrapper { background: var(--surface) !important; color: var(--text) !important; border: 1px solid var(--border) !important; border-radius: 12px !important; box-shadow: 0 8px 32px rgba(0,0,0,0.4) !important; }
        .leaflet-popup-tip { background: var(--surface) !important; border: 1px solid var(--border) !important; }
        .leaflet-popup-content { margin: 0 !important; padding: 0 !important; width: 380px !important; }
        .popup-head { padding: 16px; border-radius: 12px 12px 0 0; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-bottom: 1px solid var(--border); }
        .popup-head.critical { background: linear-gradient(135deg, #2d1117 0%, #3b1520 100%); border-bottom-color: var(--critical); }
        .popup-head.high { background: linear-gradient(135deg, #2d2011 0%, #3b2815 100%); border-bottom-color: var(--high); }
        .popup-head.likely-closed { background: linear-gradient(135deg, #1c1c24 0%, #22222e 100%); border-bottom-color: var(--closed-border); }
        .popup-head.research { background: linear-gradient(135deg, #1f1130 0%, #2a1540 100%); border-bottom-color: var(--research); }
        .popup-head h3 { font-size: 14px; font-weight: 700; line-height: 1.3; margin-bottom: 6px; }
        .popup-head h3.dimmed { color: var(--text2); }
        .popup-loc { font-size: 11px; color: var(--text2); }
        .popup-badges { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 8px; }
        .pbadge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; border-radius: 20px; font-size: 10px; font-weight: 600; }
        .pbadge.distress-critical { background: rgba(255,71,87,0.15); color: var(--critical); border: 1px solid rgba(255,71,87,0.3); }
        .pbadge.distress-high { background: rgba(255,107,53,0.15); color: var(--high); border: 1px solid rgba(255,107,53,0.3); }
        .pbadge.distress-moderate { background: rgba(59,130,246,0.15); color: var(--moderate); border: 1px solid rgba(59,130,246,0.3); }
        .pbadge.distress-low, .pbadge.distress-healthy { background: rgba(16,185,129,0.15); color: var(--low); border: 1px solid rgba(16,185,129,0.3); }
        .pbadge.source-ipeds { background: rgba(108,92,231,0.15); color: var(--accent2); border: 1px solid rgba(108,92,231,0.3); }
        .pbadge.source-990 { background: rgba(0,184,148,0.15); color: var(--hb990); border: 1px solid rgba(0,184,148,0.3); }
        .pbadge.closed-badge { background: rgba(90,90,114,0.2); color: var(--closed-border); border: 1px solid rgba(90,90,114,0.5); }
        .leaflet-control-attribution { background: var(--surface) !important; color: var(--text2) !important; font-size: 9px !important; }
        .leaflet-control-attribution a { color: var(--accent2) !important; }
        .pgrid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin: 8px 0; }
        .pgrid-item { padding: 8px; background: var(--bg); border-radius: 6px; }
        .pgrid-label { font-size: 9px; color: var(--text2); text-transform: uppercase; }
        .pgrid-val { font-family: var(--mono); font-size: 13px; font-weight: 600; margin-top: 2px; }
        .pgrid-val.good { color: var(--low); }
        .pgrid-val.bad { color: var(--critical); }
        .pgrid-val.na { color: var(--text2); font-style: italic; }
        .psection { margin: 12px 0; }
        .psection-title { font-size: 10px; font-weight: 700; color: var(--text2); text-transform: uppercase; letter-spacing: 0.5px; padding-bottom: 6px; border-bottom: 1px solid var(--border); margin-bottom: 8px; cursor: pointer; }
        .score-meter { display: flex; gap: 12px; margin: 12px 0; }
        .meter { flex: 1; padding: 12px; background: var(--bg); border-radius: 8px; text-align: center; border: 1px solid var(--border); }
        .meter-label { font-size: 9px; color: var(--text2); text-transform: uppercase; letter-spacing: 0.5px; }
        .meter-val { font-family: var(--mono); font-size: 22px; font-weight: 700; margin: 4px 0; }
        .meter-bar { height: 4px; background: var(--border); border-radius: 2px; margin-top: 6px; overflow: hidden; }
        .meter-fill { height: 100%; border-radius: 2px; }
        .completeness-row { display: flex; align-items: center; gap: 8px; margin: 8px 0; padding: 8px 10px; background: var(--bg); border-radius: 6px; }
        .completeness-row .cl { font-size: 9px; color: var(--text2); text-transform: uppercase; white-space: nowrap; }
        .completeness-row .ct { flex: 1; height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; }
        .completeness-row .cf { height: 100%; border-radius: 3px; }
        .completeness-row .cv { font-family: var(--mono); font-size: 11px; font-weight: 600; min-width: 32px; text-align: right; }
        .chip-row { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px; }
        .chip { padding: 2px 7px; border-radius: 4px; font-size: 9px; font-weight: 600; background: rgba(255,71,87,0.1); color: var(--critical); border: 1px solid rgba(255,71,87,0.2); }
        .chip.pos { background: rgba(16,185,129,0.1); color: var(--low); border-color: rgba(16,185,129,0.2); }
        .spark { display: flex; align-items: flex-end; gap: 3px; height: 32px; margin-top: 8px; }
        .spark-bar { flex: 1; border-radius: 3px 3px 0 0; min-height: 3px; }
        .spark-labels { display: flex; justify-content: space-between; font-size: 9px; color: var(--text2); margin-top: 4px; }
        .trend-arrow { font-size: 16px; } .trend-arrow.up { color: var(--low); } .trend-arrow.down { color: var(--critical); } .trend-arrow.flat { color: var(--text2); }
        .warning-item { display: flex; gap: 8px; padding: 8px 10px; margin: 4px 0; background: var(--bg); border-radius: 6px; font-size: 11px; line-height: 1.4; border-left: 3px solid var(--border); }
        .warning-item.crit { border-left-color: var(--critical); background: rgba(255,71,87,0.05); }
        .warning-item.warn { border-left-color: var(--elevated); background: rgba(255,165,2,0.05); }

        /* ‚îÄ‚îÄ Likely-closed notice in popup ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .closed-notice { margin: 8px 0 12px; padding: 10px 12px; background: rgba(90,90,114,0.12); border: 1px solid rgba(90,90,114,0.35); border-radius: 8px; font-size: 11px; color: var(--text2); line-height: 1.5; }
        .closed-notice strong { color: var(--text); display: block; margin-bottom: 3px; }
        .closed-notice .sub { font-size: 10px; margin-top: 5px; font-style: italic; }

        /* ‚îÄ‚îÄ News panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        #news-panel { position: absolute; top: 0; right: 0; z-index: 1002; width: 370px; height: 100vh; background: var(--surface); border-left: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; transform: translateX(370px); transition: transform 0.3s ease; }
        #news-panel.open { transform: translateX(0); }
        .news-panel-header { padding: 16px 16px 14px; border-bottom: 1px solid var(--border); background: linear-gradient(135deg, var(--surface) 0%, var(--surface2) 100%); flex-shrink: 0; }
        .news-panel-header-top { display: flex; align-items: flex-start; justify-content: space-between; gap: 8px; }
        .news-panel-title { font-size: 13px; font-weight: 700; line-height: 1.3; flex: 1; }
        .news-panel-sub { font-size: 10px; color: var(--text2); margin-top: 3px; }
        .news-close-btn { background: none; border: 1px solid var(--border); border-radius: 6px; color: var(--text2); cursor: pointer; font-size: 14px; width: 26px; height: 26px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.15s; }
        .news-close-btn:hover { background: var(--bg); color: var(--text); }
        .news-fetch-bar { display: flex; align-items: center; gap: 8px; margin-top: 10px; }
        .news-fetch-btn { padding: 7px 14px; background: var(--accent); border: none; border-radius: 6px; color: white; font-family: var(--font); font-size: 11px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; white-space: nowrap; }
        .news-fetch-btn:hover { opacity: 0.85; }
        .news-fetch-btn:disabled { opacity: 0.45; cursor: not-allowed; }
        .news-fetch-meta { font-size: 10px; color: var(--text2); }
        .news-fetch-meta a { color: var(--accent2); cursor: pointer; text-decoration: none; }
        .news-fetch-meta a:hover { text-decoration: underline; }
        .news-body { flex: 1; overflow-y: auto; padding: 12px; }
        .news-body::-webkit-scrollbar { width: 4px; }
        .news-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
        .news-loading { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 120px; gap: 10px; color: var(--text2); font-size: 12px; }
        .news-spinner { width: 22px; height: 22px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .news-empty { text-align: center; padding: 40px 16px; color: var(--text2); font-size: 12px; line-height: 1.6; }
        .news-empty .news-empty-icon { font-size: 28px; margin-bottom: 10px; }
        .news-signal-group { margin-bottom: 14px; }
        .news-signal-label { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text2); padding-bottom: 6px; border-bottom: 1px solid var(--border); margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
        .news-signal-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
        .news-item { padding: 10px; background: var(--bg); border-radius: 8px; margin-bottom: 6px; border-left: 3px solid var(--border); transition: border-color 0.15s; }
        .news-item:hover { border-left-color: var(--accent2); }
        .news-item.signal-closure { border-left-color: var(--critical); background: rgba(255,71,87,0.04); }
        .news-item.signal-accreditation { border-left-color: var(--high); background: rgba(255,107,53,0.04); }
        .news-item.signal-financial { border-left-color: var(--elevated); background: rgba(255,165,2,0.04); }
        .news-headline { font-size: 12px; font-weight: 600; line-height: 1.4; color: var(--text); }
        .news-headline a { color: inherit; text-decoration: none; }
        .news-headline a:hover { color: var(--accent2); }
        .news-byline { font-size: 10px; color: var(--text2); margin-top: 4px; display: flex; gap: 8px; flex-wrap: wrap; }
        .news-byline .news-source { color: var(--accent2); }
        .news-error { padding: 14px; background: rgba(255,71,87,0.08); border: 1px solid rgba(255,71,87,0.2); border-radius: 8px; font-size: 11px; color: var(--critical); line-height: 1.5; }
        /* ‚îÄ‚îÄ News button in popup head ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        .popup-news-btn { position: absolute; top: 12px; right: 12px; background: rgba(255,255,255,0.07); border: 1px solid rgba(255,255,255,0.15); border-radius: 6px; color: var(--text2); cursor: pointer; font-size: 13px; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; transition: all 0.15s; z-index: 10; }
        .popup-news-btn:hover { background: rgba(255,255,255,0.13); color: var(--text); border-color: rgba(255,255,255,0.3); }
        .popup-head { position: relative; }
    </style>
</head>
<body>
    <div id="map"></div>
    <!-- ‚îÄ‚îÄ News Panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div id="news-panel">
        <div class="news-panel-header">
            <div class="news-panel-header-top">
                <div>
                    <div class="news-panel-title" id="news-panel-title">Institution News</div>
                    <div class="news-panel-sub" id="news-panel-sub">Select an institution and fetch news</div>
                </div>
                <button class="news-close-btn" onclick="closeNewsPanel()" title="Close">u2715</button>
            </div>
            <div class="news-fetch-bar">
                <button class="news-fetch-btn" id="news-fetch-btn" onclick="fetchNews()" disabled>üì∞ Fetch News</button>
                <div class="news-fetch-meta" id="news-fetch-meta"></div>
            </div>
        </div>
        <div class="news-body" id="news-body">
            <div class="news-empty">
                <div class="news-empty-icon">üì∞</div>
                Click the <strong>üì∞</strong> button on any institution popup to load news here.
            </div>
        </div>
    </div>
    <div id="sidebar">
        <div class="sidebar-header">
            <h1>Hummingbird Intelligence</h1>
            <p id="headerSubtitle">Loading...</p>
        </div>
        <div class="sidebar-body">
            <div class="section"><div class="section-label">Search</div><div class="search-box"><span class="icon">‚åï</span><input type="text" id="searchInput" placeholder="Find an institution..." autocomplete="off"><div id="searchResults"></div></div></div>
            <div class="section"><div class="section-label">Data Source</div><div class="tabs"><div class="tab active" data-val="" onclick="setTab(this,'source')">All</div><div class="tab" data-val="IPEDS" onclick="setTab(this,'source')">IPEDS</div><div class="tab" data-val="Hummingbird_990" onclick="setTab(this,'source')">990</div></div></div>
            <div class="section"><div class="section-label">Color By</div><div class="color-tabs" id="colorTabs"><div class="color-tab active" data-mode="distress" onclick="setColorMode(this)">Distress</div><div class="color-tab" data-mode="ml_risk" onclick="setColorMode(this)">ML Risk</div><div class="color-tab" data-mode="source" onclick="setColorMode(this)">Source</div><div class="color-tab" data-mode="type" onclick="setColorMode(this)">Type</div></div></div>
            <div class="section"><div class="section-label">Institution Type</div><select id="fType"><option value="">All Types</option><optgroup label="Higher Education (IPEDS)"><option value="Public | 4-year">Public 4-Year</option><option value="Public | 2-year">Public 2-Year</option><option value="Private Non-Profit | 4-year">Private NP 4-Year</option><option value="Private Non-Profit | 2-year">Private NP 2-Year</option><option value="Private For-Profit | 4-year">Private FP 4-Year</option><option value="Private For-Profit | 2-year">Private FP 2-Year</option></optgroup><optgroup label="BMF / 990"><option value="Religious Institution">Religious</option><option value="Recreation/Camp">Recreation/Camp</option><option value="Educational Institution">Educational</option><option value="Youth Development">Youth Development</option><option value="Human Services">Human Services</option><option value="Environmental/Conservation">Environmental</option><option value="Animal/Wildlife">Animal/Wildlife</option><option value="Agriculture/Farm">Agriculture/Farm</option><option value="Housing/Residential">Housing/Residential</option><option value="Other Nonprofit">Other Nonprofit</option></optgroup></select></div>
            <div class="section"><div class="section-label">Risk Filter</div><select id="fRisk"><option value="">All Levels</option><optgroup label="Distress Score"><option value="critical">Critical Only</option><option value="high_plus">High + Critical</option><option value="moderate_plus">Moderate+</option><option value="distressed_40">Score 40+</option></optgroup><optgroup label="ML Risk (IPEDS)"><option value="ml_critical">ML Critical</option><option value="ml_high">ML High+</option><option value="ml_any_warnings">Has ML Warnings</option></optgroup><optgroup label="Status"><option value="likely_closed">Likely Closed Only</option><option value="active_only">Active Only (hide closed)</option></optgroup></select></div>
            <div class="section"><div class="section-label">Special Filters</div><select id="fSpecial"><option value="">No Special Filter</option><option value="operating_loss">üí∏ Operating Losses</option><option value="negative_equity">üî¥ Negative Net Assets</option><option value="high_debt">üè¶ High Debt Ratio</option><option value="revenue_decline">üìâ Revenue Decline</option><option value="consecutive_losses">üìâ Consecutive Losses</option><option value="has_property">üèó Has Property Data</option><option value="land_grant">üèõÔ∏è Land Grant</option></select></div>
            <div class="section"><div class="section-label">Acreage</div><select id="fAcreage"><option value="">Any Acreage</option><option value="20">20+ acres</option><option value="40">40+ acres</option><option value="60">60+ acres</option><option value="100">100+ acres</option><option value="200">200+ acres</option></select></div>
            <div class="section">
                <div class="section-label">Display</div>
                <div class="toggle-row">
                    <div class="toggle-label">Show likely closed
                        <span>greyed dashed markers</span>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="showClosed" checked onchange="applyFilters()">
                        <div class="slider"></div>
                    </label>
                </div>
            </div>
            <div class="btn-row"><button class="btn btn-primary" onclick="applyFilters()">Apply</button><button class="btn btn-ghost" onclick="resetFilters()">Reset</button></div>
            <div class="stats-grid">
                <div class="stat-card total"><div class="stat-val" id="sShowing">0</div><div class="stat-label">Plotted</div></div>
                <div class="stat-card ipeds-card"><div class="stat-val" id="sIPEDS">0</div><div class="stat-label">IPEDS</div></div>
                <div class="stat-card hb990-card"><div class="stat-val" id="s990">0</div><div class="stat-label">990</div></div>
                <div class="stat-card critical"><div class="stat-val" id="sCritical">0</div><div class="stat-label">Critical</div></div>
                <div class="stat-card high"><div class="stat-val" id="sHigh">0</div><div class="stat-label">High</div></div>
                <div class="stat-card closed-card"><div class="stat-val" id="sClosed">0</div><div class="stat-label">Likely Closed</div></div>
            </div>
        </div>
    </div>
    <button id="sidebar-toggle" onclick="toggleSidebar()">‚óÄ</button>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script>
    var map, markers, allData = [], plotData = [], colorMode = 'distress';
    var filters = { source:'' };
    var searchTimeout;
    var distressColors = {Critical:'#ff4757',High:'#ff6b35',Moderate:'#ffa502',Low:'#3b82f6',Healthy:'#10b981'};
    var sourceColors = {IPEDS:'#6c5ce7',Hummingbird_990:'#00b894'};
    var mlColors = {Critical:'#ff4757',High:'#ff6b35',Elevated:'#ffa502',Moderate:'#3b82f6',Low:'#10b981'};
    var typeColors = {
        'Religious Institution':'#e056fd','Recreation/Camp':'#00b894',
        'Educational Institution':'#6c5ce7','Youth Development':'#ffa502',
        'Human Services':'#3b82f6','Environmental/Conservation':'#2ed573',
        'Animal/Wildlife':'#ff6b35','Agriculture/Farm':'#eccc68',
        'Housing/Residential':'#a29bfe','Other Nonprofit':'#8b8fa3'
    };

    function flag(r, field) {
        var val = r[field];
        if (val === undefined || val === null || val === '') return false;
        if (val === 1 || val === '1' || val === 'True' || val === 'true' || val === true) return true;
        var n = parseFloat(val);
        return n === 1;
    }

    // ‚îÄ‚îÄ Likely-closed helper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function isLikelyClosed(r) {
        return flag(r, 'likely_closed_ipeds');
    }

    document.addEventListener('DOMContentLoaded', function() {
        map = L.map('map', {zoomControl:false}).setView([39.8,-98.5],4);
        L.control.zoom({position:'topright'}).addTo(map);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(map);
        markers = L.markerClusterGroup({chunkedLoading:true,maxClusterRadius:45,spiderfyOnMaxZoom:true,showCoverageOnHover:false});
        map.addLayer(markers);
        var legend = L.control({position:'bottomright'});
        legend.onAdd = function(){var d=L.DomUtil.create('div','map-legend');d.id='mapLegend';updateLegend(d);return d;};
        legend.addTo(map);
        var si = document.getElementById('searchInput');
        si.addEventListener('input',function(){clearTimeout(searchTimeout);searchTimeout=setTimeout(function(){doSearch(si.value)},250);});
        document.addEventListener('click',function(e){if(!e.target.closest('.search-box'))document.getElementById('searchResults').style.display='none';});
        loadCSV();
    });

    function loadCSV() {
        Papa.parse('Hummingbird_Master_Combined_v6.csv', {
            download:true, header:true, skipEmptyLines:true,
            complete:function(res) {
                allData = res.data;
                allData.forEach(function(r) {
                    if (!r.distress_category || r.distress_category.trim() === '') {
                        r.distress_category = r.distress_category_990 || '';
                    }
                    var catMap = {'High Risk':'High', 'Severe Distress':'Critical', 'Low Risk':'Low', 'Moderate Risk':'Moderate'};
                    if (catMap[r.distress_category]) r.distress_category = catMap[r.distress_category];
                    if (!r.distress_score || r.distress_score === '') {
                        r.distress_score = r.distress_score_990 || '';
                    }
                    if (!r.data_completeness_pct || r.data_completeness_pct === '') {
                        r.data_completeness_pct = r.data_completeness_990 || '';
                    }
                });

                plotData = allData.filter(function(r) {
                    var lat = parseFloat(r.latitude), lng = parseFloat(r.longitude);
                    return !isNaN(lat) && !isNaN(lng);
                });

                var nIPEDS  = plotData.filter(function(r){return r.data_source==='IPEDS'}).length;
                var n990    = plotData.filter(function(r){return r.data_source==='Hummingbird_990'}).length;
                var nClosed = plotData.filter(function(r){return isLikelyClosed(r)}).length;
                document.getElementById('headerSubtitle').textContent =
                    plotData.length.toLocaleString()+' plotted ¬∑ '+nIPEDS.toLocaleString()+' IPEDS ¬∑ '+
                    n990.toLocaleString()+' 990s ¬∑ '+nClosed+' likely closed';

                showMarkers(plotData);
            },
            error:function(){alert('Error loading CSV. Place Hummingbird_Master_Combined_v6.csv in the same folder.');}
        });
    }

    function getCompleteness(r) {
        var cp = parseFloat(r.data_completeness_pct);
        if (!isNaN(cp)) return cp;
        var c990 = parseFloat(r.data_completeness_990);
        if (!isNaN(c990)) return c990;
        var cipeds = parseFloat(r.data_completeness_ipeds);
        if (!isNaN(cipeds)) return cipeds;
        return 50;
    }

    function getColor(r) {
        // Closed always renders grey regardless of color mode
        if (isLikelyClosed(r)) return '#3a3a4a';
        if (colorMode === 'ml_risk') {
            if (r.data_source !== 'IPEDS') return '#555';
            return mlColors[r.risk_tier] || '#555';
        }
        if (colorMode === 'source') return sourceColors[r.data_source] || '#555';
        if (colorMode === 'type') {
            var it = r.institution_type || '';
            if (it.indexOf('Public') >= 0) return '#3b82f6';
            if (it.indexOf('Private Non-Profit') >= 0) return '#6c5ce7';
            if (it.indexOf('Private For-Profit') >= 0) return '#ff6b35';
            return typeColors[it] || '#8b8fa3';
        }
        return distressColors[r.distress_category] || '#555';
    }

    function showMarkers(data) {
        markers.clearLayers();
        var n=0, nIPEDS=0, n990=0, nCrit=0, nHigh=0, nClosed=0;
        var showClosed = document.getElementById('showClosed').checked;

        data.forEach(function(r){
            var lat=parseFloat(r.latitude), lng=parseFloat(r.longitude);
            if(isNaN(lat)||isNaN(lng)) return;

            var closed = isLikelyClosed(r);
            if(closed && !showClosed) return;  // respect toggle

            n++;
            if(r.data_source==='IPEDS') nIPEDS++;
            if(r.data_source==='Hummingbird_990') n990++;
            if(closed) nClosed++;
            var cat=r.distress_category||'';
            if(cat==='Critical') nCrit++;
            if(cat==='High') nHigh++;

            var color = getColor(r);

            // Closed: small, faded, dashed border ‚Äî visually subordinate
            var opts;
            if(closed) {
                opts = {
                    radius: 4,
                    fillColor: color,
                    color: '#5a5a72',
                    weight: 1.5,
                    opacity: 0.7,
                    fillOpacity: 0.5,
                    dashArray: '3,3'
                };
            } else {
                var isCrit=cat==='Critical', isHigh=cat==='High';
                opts = {
                    radius: isCrit?8:isHigh?6:5,
                    fillColor: color,
                    color: isCrit?'#ff4757':isHigh?'#ff6b35':(r.data_source==='IPEDS'?'rgba(255,255,255,0.5)':'rgba(0,184,148,0.5)'),
                    weight: isCrit?2.5:isHigh?1.5:1,
                    opacity: 1,
                    fillOpacity: 0.85
                };
            }

            var m=L.circleMarker([lat,lng], opts);
            m.bindPopup(function(){return createPopup(r);},{maxWidth:400});
            markers.addLayer(m);
        });

        document.getElementById('sShowing').textContent  = n.toLocaleString();
        document.getElementById('sIPEDS').textContent    = nIPEDS.toLocaleString();
        document.getElementById('s990').textContent      = n990.toLocaleString();
        document.getElementById('sCritical').textContent = nCrit;
        document.getElementById('sHigh').textContent     = nHigh;
        document.getElementById('sClosed').textContent   = nClosed;
    }

    function updateLegend(el) {
        el=el||document.getElementById('mapLegend'); if(!el)return;
        // Closed row appended to every mode
        var closedRow='<div style="border-top:1px solid #2a2d37;margin:6px 0 4px"></div>'
            +'<div class="row"><div class="ring" style="border-color:#5a5a72"></div>'
            +'<span style="color:#5a5a72">Likely Closed</span></div>';
        if(colorMode==='distress'){
            el.innerHTML='<h4>Distress Score</h4>'
                +'<div class="row"><div class="dot" style="background:#ff4757"></div>Critical (80+)</div>'
                +'<div class="row"><div class="dot" style="background:#ff6b35"></div>High (60-80)</div>'
                +'<div class="row"><div class="dot" style="background:#ffa502"></div>Moderate (40-60)</div>'
                +'<div class="row"><div class="dot" style="background:#3b82f6"></div>Low (20-40)</div>'
                +'<div class="row"><div class="dot" style="background:#10b981"></div>Healthy (0-20)</div>'
                +closedRow;
        } else if(colorMode==='ml_risk'){
            el.innerHTML='<h4>ML Closure Risk (IPEDS)</h4>'
                +'<div class="row"><div class="dot" style="background:#ff4757"></div>Critical (&gt;75%)</div>'
                +'<div class="row"><div class="dot" style="background:#ff6b35"></div>High (55-75%)</div>'
                +'<div class="row"><div class="dot" style="background:#ffa502"></div>Elevated (35-55%)</div>'
                +'<div class="row"><div class="dot" style="background:#3b82f6"></div>Moderate (15-35%)</div>'
                +'<div class="row"><div class="dot" style="background:#10b981"></div>Low (&lt;15%)</div>'
                +'<div class="row"><div class="dot" style="background:#555"></div>990 (no ML data)</div>'
                +closedRow;
        } else if(colorMode==='source'){
            el.innerHTML='<h4>Data Source</h4>'
                +'<div class="row"><div class="dot" style="background:#6c5ce7"></div>IPEDS</div>'
                +'<div class="row"><div class="dot" style="background:#00b894"></div>990</div>'
                +closedRow;
        } else {
            el.innerHTML='<h4>Institution Type</h4>'
                +'<div class="row"><div class="dot" style="background:#3b82f6"></div>Public</div>'
                +'<div class="row"><div class="dot" style="background:#6c5ce7"></div>Private Non-Profit</div>'
                +'<div class="row"><div class="dot" style="background:#ff6b35"></div>Private For-Profit</div>'
                +'<div class="row"><div class="dot" style="background:#e056fd"></div>Religious</div>'
                +'<div class="row"><div class="dot" style="background:#00b894"></div>Recreation/Camp</div>'
                +'<div class="row"><div class="dot" style="background:#ffa502"></div>Youth Dev.</div>'
                +'<div class="row"><div class="dot" style="background:#8b8fa3"></div>Other</div>'
                +closedRow;
        }
    }

    // --- Popup helpers (unchanged) ---
    function v(val){if(val===null||val===undefined||val===''||val==='nan'||val==='NaN')return null;return val;}
    function money(val){var x=v(val);if(x===null)return '<span class="pgrid-val na">‚Äî</span>';var n=parseFloat(x);if(isNaN(n))return '<span class="pgrid-val na">‚Äî</span>';var cls=n<0?'bad':'';if(Math.abs(n)>=1e9)return '<span class="pgrid-val '+cls+'">$'+(n/1e9).toFixed(1)+'B</span>';if(Math.abs(n)>=1e6)return '<span class="pgrid-val '+cls+'">$'+(n/1e6).toFixed(1)+'M</span>';if(Math.abs(n)>=1e3)return '<span class="pgrid-val '+cls+'">$'+(n/1e3).toFixed(0)+'K</span>';return '<span class="pgrid-val '+cls+'">$'+n.toFixed(0)+'</span>';}
    function pct(val){var x=v(val);if(x===null)return '<span class="pgrid-val na">‚Äî</span>';var n=parseFloat(x);if(isNaN(n))return '<span class="pgrid-val na">‚Äî</span>';var cls=n>5?'good':n<-5?'bad':'';return '<span class="pgrid-val '+cls+'">'+(n>0?'+':'')+n.toFixed(1)+'%</span>';}
    function trendArrow(val){var n=parseFloat(val);if(isNaN(n))return '<span class="trend-arrow flat">‚Äî</span>';if(n<-5)return '<span class="trend-arrow down">‚ñº '+n.toFixed(0)+'%</span>';if(n>5)return '<span class="trend-arrow up">‚ñ≤ +'+n.toFixed(0)+'%</span>';return '<span class="trend-arrow flat">‚óè '+n.toFixed(0)+'%</span>';}
    function gi(label,valHtml){return '<div class="pgrid-item"><div class="pgrid-label">'+label+'</div>'+valHtml+'</div>';}
    function num(val){var x=v(val);if(x===null)return '<div class="pgrid-val na">‚Äî</div>';var n=parseFloat(x);if(isNaN(n))return '<div class="pgrid-val na">‚Äî</div>';return '<div class="pgrid-val">'+n.toLocaleString(undefined,{maximumFractionDigits:0})+'</div>';}
    function ratio(val){var x=v(val);if(x===null)return '<div class="pgrid-val na">‚Äî</div>';var n=parseFloat(x);if(isNaN(n))return '<div class="pgrid-val na">‚Äî</div>';return '<div class="pgrid-val '+(n<0?'bad':'')+'">'+n.toFixed(1)+'%</div>';}
    function toggleSection(el){var c=el.nextElementSibling;if(!c)return;var sp=el.querySelector('span');if(c.style.display==='none'){c.style.display='';if(sp)sp.textContent='‚ñº';}else{c.style.display='none';if(sp)sp.textContent='‚ñ∂';}}

    function createPopup(r) {
        var name=r.institution_name||'Unknown', cat=r.distress_category||'';
        var ds=parseFloat(r.distress_score), source=r.data_source||'', isIPEDS=source==='IPEDS';
        var closed=isLikelyClosed(r);

        // Head class ‚Äî closed gets its own muted style
        var headClass = closed ? 'likely-closed' : (cat==='Critical'?'critical':cat==='High'?'high':'');

        // Badges
        var badges='';
        // Closed badge comes first, prominently
        if(closed) {
            badges+='<span class="pbadge closed-badge">‚¨° Likely Closed</span>';
        }
        if(cat){
            var bc=cat.toLowerCase();
            // Label as "Last Known" score for closed institutions
            var scoreLabel = closed ? 'Last Known: ' : 'Distress: ';
            badges+='<span class="pbadge distress-'+bc+'">'+scoreLabel+(isNaN(ds)?cat:ds.toFixed(0)+' ‚Äî '+cat)+'</span>';
        }
        badges+='<span class="pbadge source-'+(isIPEDS?'ipeds':'990')+'">'+(isIPEDS?'IPEDS':'990')+'</span>';
        if(v(r.institution_type))badges+='<span class="pbadge" style="background:rgba(255,255,255,0.05);color:var(--text2);border:1px solid var(--border)">'+r.institution_type+'</span>';
        if(v(r.ntee_code))badges+='<span class="pbadge" style="background:rgba(162,155,254,0.1);color:var(--accent2);border:1px solid rgba(162,155,254,0.2)">NTEE: '+r.ntee_code+'</span>';
        if(r.is_land_grant==='Land Grant Institution')badges+='<span class="pbadge" style="background:rgba(16,185,129,0.15);color:#10b981;border:1px solid rgba(16,185,129,0.3)">üèõ Land Grant</span>';

        // Location
        var locParts=[];
        if(v(r.address))locParts.push(r.address);
        var cs=(r.city||'')+((r.city&&r.state)?', ':'')+(r.state||'')+(r.zip_code?' '+r.zip_code:'');
        if(cs.trim())locParts.push(cs);

        // Score meter ‚Äî colour and label adapted for closed
        var dsBar=!isNaN(ds)?ds:0;
        var dsC = closed ? '#5a5a72' : (ds>=80?'var(--critical)':ds>=60?'var(--high)':ds>=40?'var(--elevated)':'var(--low)');
        var ml=parseFloat(r.closure_risk_score), mlTier=r.risk_tier||'';
        var meterLabel = closed ? 'Last Known Score' : 'Distress Score';
        var meterHtml='<div class="score-meter"><div class="meter"><div class="meter-label">'+meterLabel+'</div>'
            +'<div class="meter-val" style="color:'+dsC+'">'+(isNaN(ds)?'‚Äî':ds.toFixed(0))+'</div>'
            +'<div class="meter-bar"><div class="meter-fill" style="width:'+dsBar+'%;background:'+dsC+'"></div></div>'
            +'</div></div>';

        // Closed notice banner ‚Äî shown instead of ML analysis for closed schools
        var closedNotice='';
        if(closed) {
            var scoreYr = v(r.score_year_ipeds);
            closedNotice='<div class="closed-notice">'
                +'<strong>‚¨° Likely Closed Institution</strong>'
                +'No enrollment or financial data found for 2023‚Äì2024. This institution may have ceased operations or stopped IPEDS reporting.'
                +(scoreYr?'<div class="sub">Score and indicators above reflect last available data ('
                    +parseFloat(scoreYr).toFixed(0)+'). Shown for reference only.</div>':'')
                +'</div>';
        }

        // ML Closure Pattern Analysis ‚Äî only for active IPEDS institutions
        var wflags=r.ml_warning_flags||'';
        var wHtml='';
        if(isIPEDS && !closed && (!isNaN(ml) || wflags)){
            var mlC=ml>=0.75?'var(--critical)':ml>=0.55?'var(--high)':ml>=0.35?'var(--elevated)':'var(--low)';
            var mlPct=!isNaN(ml)?(ml*100).toFixed(0)+'%':'‚Äî';
            var mlLabel=mlTier||'N/A';
            var wi=wflags?wflags.split(' | ').filter(Boolean):[];
            var flagCount=wi.length;
            var sectionColor=ml>=0.55?'var(--critical)':ml>=0.35?'var(--elevated)':'var(--text2)';
            wHtml='<div class="psection"><div class="psection-title" onclick="toggleSection(this)" style="cursor:pointer">';
            wHtml+='<span style="color:'+sectionColor+'">üî¨ Closure Pattern Analysis</span>';
            if(!isNaN(ml))wHtml+=' <span style="font-size:9px;color:'+mlC+';font-family:var(--mono)">'+mlPct+' '+mlLabel+'</span>';
            if(flagCount>0)wHtml+=' <span style="font-size:9px;color:var(--text2)">('+flagCount+' flag'+(flagCount>1?'s':'')+')</span>';
            wHtml+=' <span style="float:right;font-size:8px">‚ñ∂</span></div>';
            wHtml+='<div style="display:none">';
            if(!isNaN(ml)){
                wHtml+='<div style="padding:8px 10px;background:var(--bg);border-radius:6px;margin:4px 0;font-size:10px;display:flex;justify-content:space-between;align-items:center">';
                wHtml+='<span style="color:var(--text2)">ML Closure Risk Score</span>';
                wHtml+='<span style="color:'+mlC+';font-weight:600;font-family:var(--mono)">'+mlPct+'</span></div>';
                wHtml+='<div style="padding:2px 10px 8px;font-size:9px;color:var(--text2);line-height:1.4">Pattern-matching model trained on verified institutional closures (2014‚Äì2024). Identifies structural similarities to institutions that subsequently closed.</div>';
            }
            if(flagCount>0){
                wHtml+='<div class="warning-list">';
                wi.forEach(function(f){
                    var c=f.indexOf('CRITICAL')>=0?'crit':'warn';
                    var i=f.indexOf('CRITICAL')>=0?'üî¥':'üü°';
                    wHtml+='<div class="warning-item '+c+'"><span style="flex-shrink:0;font-size:12px">'+i+'</span><span style="color:var(--text)">'+f+'</span></div>';
                });
                wHtml+='</div>';
            } else if(!isNaN(ml) && ml<0.15){
                wHtml+='<div style="padding:6px 10px;font-size:10px;color:var(--low)">‚úì No closure pattern flags detected</div>';
            }
            wHtml+='</div></div>';
        }

        // Completeness
        var cp=getCompleteness(r);
        var cpC = closed ? '#5a5a72' : (cp>=90?'var(--low)':cp>=75?'var(--moderate)':cp>=60?'var(--elevated)':'var(--critical)');
        var compBar='<div class="completeness-row"><span class="cl">Data</span><div class="ct"><div class="cf" style="width:'+cp+'%;background:'+cpC+'"></div></div><span class="cv" style="color:'+cpC+'">'+cp.toFixed(0)+'%</span></div>';

        // Data quality tier (990 only)
        var tierHtml='';
        if(!isIPEDS && v(r.data_quality_tier)){
            var tier=r.data_quality_tier, tC=tier==='full_trend'?'var(--low)':tier==='snapshot'?'var(--elevated)':'var(--critical)';
            tierHtml='<div style="padding:6px 10px;background:var(--bg);border-radius:6px;margin:4px 0;font-size:10px"><span style="color:var(--text2)">Data tier: </span><span style="color:'+tC+';font-weight:600">'+tier+'</span>';
            if(v(r.n_filing_years))tierHtml+=' <span style="color:var(--text2)">¬∑ '+r.n_filing_years+' filing yrs</span>';
            if(v(r.score_year_actual))tierHtml+=' <span style="color:var(--text2)">¬∑ scored '+r.score_year_actual+'</span>';
            tierHtml+='</div>';
        }

        // Distress flags chips
        var chips=[];
        if(flag(r,'flag_enrollment_decline'))chips.push('üìâ 2yr Enrollment Decline');
        if(flag(r,'flag_operating_losses')||flag(r,'flag_990_operating_loss'))chips.push('üí∏ Operating Loss (Current Year)');
        if(flag(r,'flag_990_consecutive_losses'))chips.push('üìâ Consecutive Annual Losses');
        if(flag(r,'flag_negative_net_worth')||flag(r,'flag_990_negative_net_assets'))chips.push('üî¥ Negative Net Assets');
        if(flag(r,'flag_low_equity_ratio')||flag(r,'flag_990_low_equity'))chips.push('üí≥ Equity Ratio Below 30%');
        if(flag(r,'flag_high_debt')||flag(r,'flag_990_high_debt'))chips.push('üè¶ Debt Exceeds 50% of Assets');
        if(flag(r,'flag_990_revenue_decline_1yr'))chips.push('üìâ 1yr Revenue Decline');
        if(flag(r,'flag_990_revenue_decline_2yr'))chips.push('üìâ 2yr Revenue Decline');
        if(flag(r,'flag_high_land_potential'))chips.push({t:'üåü High Land Value Potential',p:1});
        else if(flag(r,'flag_land_potential'))chips.push({t:'üå± Land Asset Potential',p:1});
        var chHtml='';
        if(chips.length){chHtml='<div class="chip-row" style="margin:8px 0">';chips.forEach(function(c){chHtml+=typeof c==='object'?'<span class="chip pos">'+c.t+'</span>':'<span class="chip">'+c+'</span>';});chHtml+='</div>';}

        // Subdomain bars
        var subHtml='';
        function subBar(subs,maxV){
            var h='<div class="psection"><div class="psection-title" onclick="toggleSection(this)">üìä Distress Subdomains <span style="float:right;font-size:8px">‚ñº</span></div><div>';
            subs.forEach(function(s){var val=parseFloat(s[1]);if(isNaN(val))return;var p=Math.min(val/maxV*100,100);var c=val>=(maxV*0.67)?'var(--critical)':val>=(maxV*0.4)?'var(--elevated)':'var(--low)';
                h+='<div style="display:flex;align-items:center;gap:8px;margin:3px 0;font-size:10px"><span style="width:70px;color:var(--text2)">'+s[0]+'</span><div style="flex:1;height:6px;background:var(--border);border-radius:3px;overflow:hidden"><div style="width:'+p+'%;height:100%;background:'+c+';border-radius:3px"></div></div><span style="width:24px;text-align:right;font-family:var(--mono);font-size:9px">'+val.toFixed(0)+'</span></div>';
            });return h+'</div></div>';}
        if(isIPEDS){
            var sd=[['Solvency',r.solvency_score_ipeds],['Liquidity',r.liquidity_score_ipeds],['Operating',r.operating_score_ipeds],['Enrollment',r.enrollment_score_ipeds],['Academic',r.academic_score_ipeds],['Demand',r.demand_score_ipeds],['Trend',r.trend_score_ipeds]];
            if(sd.some(function(s){return !isNaN(parseFloat(s[1]))}))subHtml=subBar(sd,15);
        } else {
            var sd=[['Solvency',r.solvency_score_990],['Liquidity',r.liquidity_score_990],['Operating',r.operating_score_990],['Trend',r.trend_score_990],['Red Flags',r.red_flag_score_990]];
            if(sd.some(function(s){return !isNaN(parseFloat(s[1]))}))subHtml=subBar(sd,20);
        }

        // Financials
        var r24=parseFloat(r.revenue_2024)||0,r23=parseFloat(r.revenue_2023)||0,r22=parseFloat(r.revenue_2022)||0,mx=Math.max(r24,r23,r22,1);
        var fin='<div class="psection"><div class="psection-title" onclick="toggleSection(this)">üí∞ Financials <span style="float:right;font-size:8px">‚ñº</span></div><div><div class="pgrid">';
        fin+=gi('Revenue 2024',money(r.revenue_2024))+gi('Expenses 2024',money(r.expenses_2024));
        fin+=gi('Net Income',money(r.net_income_2024))+gi('Net Assets',money(r.net_assets_2024));
        fin+=gi('Total Assets',money(r.assets_2024))+gi('Liabilities',money(r.liabilities_2024));
        fin+=gi('Equity Ratio',ratio(r.equity_ratio))+gi('Op. Margin',ratio(r.operating_margin));
        fin+=gi('Debt Ratio',ratio(r.debt_ratio))+gi('Rev 2yr Œî',pct(r.revenue_2yr_pct));
        if(isIPEDS){fin+=gi('Tuition Dep.',ratio(r.tuition_dependency));if(v(r.endowment_per_fte))fin+=gi('Endow./FTE',money(r.endowment_per_fte));}
        if(v(r.long_term_debt))fin+=gi('LT Debt',money(r.long_term_debt));
        fin+='</div><div class="spark">';
        fin+='<div class="spark-bar" style="height:'+(r22/mx*100)+'%;background:var(--accent)"></div>';
        fin+='<div class="spark-bar" style="height:'+(r23/mx*100)+'%;background:var(--accent2)"></div>';
        fin+='<div class="spark-bar" style="height:'+(r24/mx*100)+'%;background:'+(r24<r22?'var(--critical)':'var(--low)')+'"></div>';
        fin+='</div><div class="spark-labels"><span>2022</span><span>2023</span><span>2024</span></div></div></div>';

        // Enrollment (IPEDS only)
        var enr='';
        if(isIPEDS){
            enr='<div class="psection"><div class="psection-title" onclick="toggleSection(this)">üìä Enrollment & Admissions <span style="float:right;font-size:8px">‚ñº</span></div><div><div class="pgrid">';
            enr+=gi('Total 2024',num(r.enrollment_2024));
            enr+=gi('1yr Œî','<div class="pgrid-val">'+trendArrow(r.enrollment_yoy_pct)+'</div>');
            enr+=gi('Retention',ratio(r.retention_rate))+gi('Graduation',ratio(r.graduation_rate));
            if(v(r.admission_rate))enr+=gi('Admit Rate',ratio(r.admission_rate));
            if(v(r.yield_rate))enr+=gi('Yield Rate',ratio(r.yield_rate));
            if(v(r.tuition_2025))enr+=gi('Tuition \'25',money(r.tuition_2025));
            if(v(r.student_faculty_ratio))enr+=gi('Stu:Fac','<div class="pgrid-val">'+r.student_faculty_ratio+':1</div>');
            enr+='</div></div></div>';
        }

        // Property
        var prop='<div class="psection"><div class="psection-title" onclick="toggleSection(this)">üèó Property & Land <span style="float:right;font-size:8px">‚ñº</span></div><div><div class="pgrid">';
        if(v(r.verified_acres))prop+=gi('Acres','<div class="pgrid-val">'+parseFloat(r.verified_acres).toLocaleString(undefined,{maximumFractionDigits:1})+'</div>');
        else if(v(r.acreage_raw)){var ac=parseFloat(r.acreage_raw);prop+=gi('Acreage','<div class="pgrid-val">'+(isNaN(ac)?r.acreage_raw:ac.toLocaleString(undefined,{maximumFractionDigits:1}))+'</div>');}
        else prop+=gi('Acreage','<div class="pgrid-val" style="color:var(--text2);font-style:italic;font-family:var(--font)">Not yet verified</div>');
        if(v(r.land_book_value))prop+=gi('Land Value',money(r.land_book_value));
        if(v(r.plant_property_equipment))prop+=gi('PP&E',money(r.plant_property_equipment));
        if(v(r.long_term_debt))prop+=gi('LT Debt',money(r.long_term_debt));
        prop+='</div></div></div>';

        // Identifiers (collapsed)
        var ids='<div class="psection"><div class="psection-title" onclick="toggleSection(this)">üè∑ Identifiers <span style="float:right;font-size:8px">‚ñ∂</span></div><div style="display:none"><div class="pgrid">';
        if(v(r.unitid))ids+=gi('UNITID','<div class="pgrid-val">'+r.unitid+'</div>');
        if(v(r.ein))ids+=gi('EIN','<div class="pgrid-val">'+r.ein+'</div>');
        if(v(r.ntee_code))ids+=gi('NTEE','<div class="pgrid-val">'+r.ntee_code+'</div>');
        if(v(r.subsection_code_bmf))ids+=gi('501(c)','<div class="pgrid-val">¬ß'+r.subsection_code_bmf+'</div>');
        if(v(r.ruling_date))ids+=gi('Ruling Date','<div class="pgrid-val">'+r.ruling_date+'</div>');
        if(v(r.eo_status_bmf))ids+=gi('EO Status','<div class="pgrid-val">'+r.eo_status_bmf+'</div>');
        if(v(r.county))ids+=gi('County','<div class="pgrid-val">'+r.county+'</div>');
        if(v(r.urbanization))ids+=gi('Locale','<div class="pgrid-val" style="font-size:10px">'+r.urbanization+'</div>');
        if(v(r.fte_staff))ids+=gi('FTE Staff',num(r.fte_staff));
        if(v(r.filing_type_primary))ids+=gi('Filing Type','<div class="pgrid-val">'+r.filing_type_primary+'</div>');
        if(v(r.affiliation))ids+=gi('Affiliation','<div class="pgrid-val" style="font-size:10px">'+r.affiliation+'</div>');
        ids+='</div></div></div>';

        // Assemble ‚Äî closed name is dimmed
        var nameHtml = closed ? '<h3 class="dimmed">‚¨° '+name+'</h3>' : '<h3>'+name+'</h3>';
        var uid = r.unitid || '';
        var newsBtnHtml = '<button class="popup-news-btn" onclick="openNewsPanel(\'' + uid + '\')" title="Load news for this institution">üì∞</button>';
        return '<div>'
            +'<div class="popup-head '+headClass+'">'+nameHtml+newsBtnHtml
            +'<div class="popup-loc">'+locParts.join('<br>')+'</div>'
            +'<div class="popup-badges">'+badges+'</div></div>'
            +'<div class="popup-content" style="padding:12px;max-height:400px;overflow-y:auto">'
            +meterHtml+closedNotice+compBar+tierHtml+chHtml+subHtml+wHtml+fin+enr+prop+ids
            +'</div></div>';
    }

    // Search
    function doSearch(q){
        var el=document.getElementById('searchResults');
        if(q.length<2){el.style.display='none';return;}
        var ql=q.toLowerCase();
        var hits=plotData.filter(function(r){return (r.institution_name||'').toLowerCase().indexOf(ql)>=0;}).slice(0,8);
        if(!hits.length){el.innerHTML='<div class="sr-item"><span class="sr-meta">No results</span></div>';el.style.display='block';return;}
        el.innerHTML=hits.map(function(r,i){
            var cat=r.distress_category||'';
            var closedTag = isLikelyClosed(r) ? ' ¬∑ <span style="color:#5a5a72">Likely Closed</span>' : '';
            return '<div class="sr-item" onclick="jumpTo('+i+')">'
                +'<div class="sr-name">'+(isLikelyClosed(r)?'‚¨° ':'')+r.institution_name+'</div>'
                +'<div class="sr-meta">'+(r.city||'')+', '+(r.state||'')+' ¬∑ '+(r.data_source||'')
                +(cat?' ¬∑ <span style="color:'+(distressColors[cat]||'#888')+'">'+cat+'</span>':'')
                +closedTag+'</div></div>';
        }).join('');
        el.style.display='block';
        el._hits=hits;
    }
    function jumpTo(i){
        var el=document.getElementById('searchResults');
        var r=el._hits[i];if(!r)return;
        var lat=parseFloat(r.latitude),lng=parseFloat(r.longitude);
        if(!isNaN(lat)&&!isNaN(lng)){
            map.setView([lat,lng],14);
            markers.eachLayer(function(l){var ll=l.getLatLng();if(Math.abs(ll.lat-lat)<0.0001&&Math.abs(ll.lng-lng)<0.0001)l.openPopup();});
        }
        el.style.display='none';
        document.getElementById('searchInput').value=r.institution_name||'';
    }

    // Filters
    function setTab(el,key){
        el.parentElement.querySelectorAll('.tab').forEach(function(t){t.classList.remove('active');});
        el.classList.add('active');
        filters[key]=el.dataset.val;
        applyFilters();
    }
    function setColorMode(el){
        document.querySelectorAll('.color-tab').forEach(function(t){t.classList.remove('active');});
        el.classList.add('active');
        colorMode=el.dataset.mode;
        updateLegend();
        applyFilters();
    }
    function applyFilters(){
        var f={
            source:filters.source,
            type:document.getElementById('fType').value,
            risk:document.getElementById('fRisk').value,
            special:document.getElementById('fSpecial').value,
            acreage:document.getElementById('fAcreage').value
        };
        var showClosed = document.getElementById('showClosed').checked;

        var filtered=plotData.filter(function(r){
            var closed = isLikelyClosed(r);

            // Toggle: hide closed unless explicitly filtering for them
            if(closed && !showClosed && f.risk !== 'likely_closed') return false;

            if(f.source&&r.data_source!==f.source)return false;
            if(f.type&&r.institution_type!==f.type)return false;

            // Status filters
            if(f.risk==='likely_closed') return closed;
            if(f.risk==='active_only' && closed) return false;

            if(f.risk==='critical'&&r.distress_category!=='Critical')return false;
            if(f.risk==='high_plus'){var c=r.distress_category;if(c!=='Critical'&&c!=='High')return false;}
            if(f.risk==='moderate_plus'){var c=r.distress_category;if(c!=='Critical'&&c!=='High'&&c!=='Moderate')return false;}
            if(f.risk==='distressed_40'){var d=parseFloat(r.distress_score);if(isNaN(d)||d<40)return false;}
            if(f.risk==='ml_critical'&&r.risk_tier!=='Critical')return false;
            if(f.risk==='ml_high'&&r.risk_tier!=='Critical'&&r.risk_tier!=='High')return false;
            if(f.risk==='ml_any_warnings'&&!(parseInt(r.ml_warning_count)>0))return false;

            if(f.special==='operating_loss'&&!flag(r,'flag_operating_losses')&&!flag(r,'flag_990_operating_loss'))return false;
            if(f.special==='negative_equity'&&!flag(r,'flag_negative_net_worth')&&!flag(r,'flag_990_negative_net_assets'))return false;
            if(f.special==='high_debt'&&!flag(r,'flag_high_debt')&&!flag(r,'flag_990_high_debt'))return false;
            if(f.special==='revenue_decline'&&!flag(r,'flag_990_revenue_decline_1yr')&&!flag(r,'flag_enrollment_decline'))return false;
            if(f.special==='consecutive_losses'&&!flag(r,'flag_990_consecutive_losses'))return false;
            if(f.special==='has_property'&&!flag(r,'has_property_data'))return false;
            if(f.special==='land_grant'&&r.is_land_grant!=='Land Grant Institution')return false;
            if(f.acreage){var minAcres=parseFloat(f.acreage);var acres=parseFloat(r.verified_acres)||parseFloat(r.acreage_raw)||0;if(acres<minAcres)return false;}
            return true;
        });
        showMarkers(filtered);
    }
    function resetFilters(){
        filters={source:''};
        document.querySelectorAll('.tab').forEach(function(t,i){t.classList.toggle('active',i===0);});
        document.getElementById('fType').value='';
        document.getElementById('fRisk').value='';
        document.getElementById('fSpecial').value='';
        document.getElementById('fAcreage').value='';
        document.getElementById('fAcreage').value='';
        document.getElementById('searchInput').value='';
        document.getElementById('showClosed').checked=true;
        showMarkers(plotData);
    }
    function toggleSidebar(){
        var sb=document.getElementById('sidebar');
        sb.classList.toggle('collapsed');
        document.getElementById('sidebar-toggle').textContent=sb.classList.contains('collapsed')?'‚ñ∂':'‚óÄ';
        setTimeout(function(){map.invalidateSize();},350);
    }


    // =========================================================================
    // NEWS PANEL \u2014 Google News RSS via corsproxy.io
    // No API key required. Works from any file:// or http:// context.
    // =========================================================================

    var _newsCurrentUid  = null;
    var _newsCurrentName = null;

    // Signal classification \u2014 scans headline + snippet text
    var NEWS_SIGNALS = {
        closure: {
            label: 'Closure Signal',
            color: '#ff4757',
            keywords: ['clos','shut down','teach-out','ceasing operations','wind down','discontinu','merger','acqui','closing']
        },
        accreditation: {
            label: 'Accreditation',
            color: '#ff6b35',
            keywords: ['accreditation','hlc','sacscoc','neche','wscuc','nwccu','sacs','probation','sanctions','show cause']
        },
        financial: {
            label: 'Financial Distress',
            color: '#ffa502',
            keywords: ['deficit','budget cut','layoff','restructur','financial difficult','bankruptcy','default','debt']
        }
    };

    function classifyArticle(title, snippet) {
        var text = ((title || '') + ' ' + (snippet || '')).toLowerCase();
        var types = Object.keys(NEWS_SIGNALS);
        for (var i = 0; i < types.length; i++) {
            var kws = NEWS_SIGNALS[types[i]].keywords;
            for (var j = 0; j < kws.length; j++) {
                if (text.indexOf(kws[j]) >= 0) return types[i];
            }
        }
        return 'general';
    }

    function newsCacheKey(uid) { return 'hb_news_v2_' + uid; }

    function getNewsCache(uid) {
        try {
            var raw = localStorage.getItem(newsCacheKey(uid));
            if (!raw) return null;
            return JSON.parse(raw);
        } catch(e) { return null; }
    }

    function setNewsCache(uid, articles) {
        try {
            localStorage.setItem(newsCacheKey(uid), JSON.stringify({
                ts: Date.now(),
                articles: articles
            }));
        } catch(e) {}
    }

    function formatCacheAge(ts) {
        var mins = Math.floor((Date.now() - ts) / 60000);
        if (mins < 2)  return 'just now';
        if (mins < 60) return mins + 'm ago';
        var hrs = Math.floor(mins / 60);
        if (hrs < 24)  return hrs + 'h ago';
        return Math.floor(hrs / 24) + 'd ago';
    }

    function openNewsPanel(uid) {
        _newsCurrentUid  = uid;

        // Find the matching record
        var rec = null;
        for (var i = 0; i < allData.length; i++) {
            if (String(allData[i].unitid) === String(uid)) { rec = allData[i]; break; }
        }
        _newsCurrentName = rec ? (rec.institution_name || uid) : uid;

        // Update panel header
        document.getElementById('news-panel-title').textContent = _newsCurrentName;
        var sub = rec ? [(rec.city||''), (rec.state||'')].filter(Boolean).join(', ') : '';
        document.getElementById('news-panel-sub').textContent = sub;

        var fetchBtn = document.getElementById('news-fetch-btn');
        fetchBtn.disabled = false;

        // Load from cache if available, otherwise show prompt
        var cached = getNewsCache(uid);
        if (cached) {
            var age = formatCacheAge(cached.ts);
            document.getElementById('news-fetch-meta').innerHTML =
                'Cached ' + age + ' &nbsp;\u00B7&nbsp; <a onclick="forceRefreshNews()" style="cursor:pointer;color:var(--accent2)">\u21BB Refresh</a>';
            renderNewsArticles(cached.articles);
        } else {
            document.getElementById('news-fetch-meta').innerHTML = '';
            document.getElementById('news-body').innerHTML =
                '<div class="news-empty">'
                + '<div class="news-empty-icon">\uD83D\uDCF0</div>'
                + '<strong>' + _newsCurrentName + '</strong><br><br>'
                + 'Click <strong>Fetch News</strong> to pull the latest headlines from Google News.'
                + '</div>';
        }

        document.getElementById('news-panel').classList.add('open');
    }

    function closeNewsPanel() {
        document.getElementById('news-panel').classList.remove('open');
    }

    function forceRefreshNews() {
        fetchNews(true);
    }

    function fetchNews(force) {
        if (!_newsCurrentUid || !_newsCurrentName) return;

        // Serve from cache unless forced refresh
        if (!force) {
            var cached = getNewsCache(_newsCurrentUid);
            if (cached) { renderNewsArticles(cached.articles); return; }
        }

        // Show loading state
        document.getElementById('news-body').innerHTML =
            '<div class="news-loading"><div class="news-spinner"></div>Fetching from Google News\u2026</div>';
        document.getElementById('news-fetch-btn').disabled = true;
        document.getElementById('news-fetch-meta').innerHTML = 'Fetching\u2026';

        // Build Google News RSS URL, then wrap in allorigins proxy
        var query = encodeURIComponent('"' + _newsCurrentName + '"');
        var rssUrl = 'https://news.google.com/rss/search?q=' + query + '&hl=en-US&gl=US&ceid=US:en';
        var proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(rssUrl);

        fetch(proxyUrl)
            .then(function(res) {
                if (!res.ok) throw new Error('Proxy returned ' + res.status);
                return res;
            })
            .then(function(data) {
                return data.text();
            })
            .then(function(text) {
                if (!text) throw new Error('Empty proxy response');
                return parseRSSFeed(text);
            })
            .then(function(articles) {
                setNewsCache(_newsCurrentUid, articles);
                document.getElementById('news-fetch-btn').disabled = false;
                var age = 'just now';
                document.getElementById('news-fetch-meta').innerHTML =
                    'Fetched ' + age + ' &nbsp;\u00B7&nbsp; ' + articles.length + ' results'
                    + ' &nbsp;\u00B7&nbsp; <a onclick="forceRefreshNews()" style="cursor:pointer;color:var(--accent2)">\u21BB Refresh</a>';
                renderNewsArticles(articles);
            })
            .catch(function(err) {
                document.getElementById('news-fetch-btn').disabled = false;
                document.getElementById('news-fetch-meta').innerHTML = 'Error';
                document.getElementById('news-body').innerHTML =
                    '<div class="news-error">'
                    + '<strong>Could not fetch news</strong><br><br>'
                    + err.message + '<br><br>'
                    + 'Check your internet connection and try again.'
                    + '</div>';
            });
    }

    function parseRSSFeed(xmlString) {
        var parser = new DOMParser();
        var doc = parser.parseFromString(xmlString, 'application/xml');
        var items = doc.querySelectorAll('item');
        var articles = [];

        items.forEach(function(item) {
            var title   = (item.querySelector('title')   || {}).textContent || '';
            var link    = (item.querySelector('link')    || {}).textContent || '';
            var pubDate = (item.querySelector('pubDate') || {}).textContent || '';
            var snippet = (item.querySelector('description') || {}).textContent || '';

            // Strip HTML tags from snippet
            snippet = snippet.replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim();

            // Strip " - Source" suffix Google appends to titles
            var source = '';
            var titleMatch = title.match(/^(.*?)\s+-\s+([^-]+)$/);
            if (titleMatch) {
                title  = titleMatch[1].trim();
                source = titleMatch[2].trim();
            }

            // Format date
            var dateStr = '';
            if (pubDate) {
                var d = new Date(pubDate);
                if (!isNaN(d)) dateStr = d.toISOString().slice(0, 10);
            }

            // Skip removed/unavailable articles
            if (!title || title === '[Removed]') return;

            articles.push({
                title:   title,
                source:  source,
                date:    dateStr,
                url:     link,
                snippet: snippet,
                signal:  classifyArticle(title, snippet)
            });
        });

        return articles;
    }

    function renderNewsArticles(articles) {
        var body = document.getElementById('news-body');

        if (!articles || articles.length === 0) {
            body.innerHTML =
                '<div class="news-empty">'
                + '<div class="news-empty-icon">\uD83D\uDD0D</div>'
                + 'No recent news found for<br><strong>' + _newsCurrentName + '</strong>.'
                + '</div>';
            return;
        }

        // Group by signal type \u2014 signals first, general last
        var groups = { closure: [], accreditation: [], financial: [], general: [] };
        articles.forEach(function(a) { groups[a.signal].push(a); });

        var html = '';
        ['closure', 'accreditation', 'financial', 'general'].forEach(function(type) {
            var items = groups[type];
            if (!items.length) return;

            var sig   = NEWS_SIGNALS[type];
            var label = sig ? sig.label : 'General';
            var color = sig ? sig.color : '#8b8fa3';

            html += '<div class="news-signal-group">';
            html += '<div class="news-signal-label">'
                + '<span class="news-signal-dot" style="background:' + color + '"></span>'
                + label
                + ' <span style="color:var(--text2);font-weight:400">(' + items.length + ')</span>'
                + '</div>';

            items.forEach(function(a) {
                var itemClass = 'news-item' + (type !== 'general' ? ' signal-' + type : '');
                html += '<div class="' + itemClass + '">';
                html += '<div class="news-headline"><a href="' + a.url + '" target="_blank" rel="noopener">' + a.title + '</a></div>';
                html += '<div class="news-byline">';
                if (a.source) html += '<span class="news-source">' + a.source + '</span>';
                if (a.date)   html += '<span>' + a.date + '</span>';
                html += '</div>';
                if (a.snippet) html += '<div style="font-size:10px;color:var(--text2);margin-top:4px;line-height:1.4">' + a.snippet.slice(0, 120) + (a.snippet.length > 120 ? '\u2026' : '') + '</div>';
                html += '</div>';
            });

            html += '</div>';
        });

        body.innerHTML = html;
    }


    </script>
</body>
</html>